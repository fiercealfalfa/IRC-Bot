The code here comes from a lot of different sources, I will try to provide acknowledgements here. 